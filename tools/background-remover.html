<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Remove Background - Free Online</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f5f7fa;
    text-align: center;
  }
  #inputImage {
    max-width: 400px;
    margin: 20px auto;
    display: block;
  }
  #outputCanvas {
    margin-top: 20px;
    border: 1px solid #ddd;
    max-width: 400px;
  }
  button {
    padding: 12px 24px;
    font-size: 16px;
    background: #2563eb;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  #loading {
    margin: 10px;
  }
</style>
</head>
<body>

<h1>Remove Background from Person (Free, Browser)</h1>
<input type="file" id="fileInput" accept="image/*" />
<br />
<button id="removeBtn" disabled>Remove Background</button>
<div id="loading"></div>
<canvas id="outputCanvas"></canvas>

<!-- TensorFlow.js and BodyPix -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.8.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.0/dist/body-pix.min.js"></script>

<script>
  const fileInput = document.getElementById('fileInput');
  const removeBtn = document.getElementById('removeBtn');
  const loading = document.getElementById('loading');
  const outputCanvas = document.getElementById('outputCanvas');
  const ctx = outputCanvas.getContext('2d');
  let img = new Image();

  let net;

  // Load BodyPix model on page load
  async function loadModel() {
    loading.textContent = '⏳ Loading AI model... please wait';
    net = await bodyPix.load({
      architecture: 'MobileNetV1',
      outputStride: 16,
      multiplier: 0.75,
      quantBytes: 2
    });
    loading.textContent = '✅ Model loaded. Select an image.';
    removeBtn.disabled = false;
  }
  loadModel();

  fileInput.addEventListener('change', () => {
    const file = fileInput.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      img.src = e.target.result;
      img.onload = () => {
        outputCanvas.width = img.width;
        outputCanvas.height = img.height;
        ctx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
        ctx.drawImage(img, 0, 0);
        loading.textContent = '';
      };
    };
    reader.readAsDataURL(file);
  });

  removeBtn.addEventListener('click', async () => {
    if (!img.src) return alert('Please select an image first.');

    loading.textContent = '⏳ Removing background...';
    // Segment person from background
    const segmentation = await net.segmentPerson(img, {
      internalResolution: 'medium',
      segmentationThreshold: 0.7
    });

    // Create new ImageData with transparent background outside person
    const imgWidth = img.width;
    const imgHeight = img.height;

    const imgCanvas = document.createElement('canvas');
    imgCanvas.width = imgWidth;
    imgCanvas.height = imgHeight;
    const imgCtx = imgCanvas.getContext('2d');
    imgCtx.drawImage(img, 0, 0);

    const imageData = imgCtx.getImageData(0, 0, imgWidth, imgHeight);
    const pixels = imageData.data;
    const mask = segmentation.data;

    for (let i = 0; i < mask.length; i++) {
      const pixelIndex = i * 4;
      if (mask[i] === 0) {
        // Background pixel, set alpha to 0 (transparent)
        pixels[pixelIndex + 3] = 0;
      }
    }
    imgCtx.putImageData(imageData, 0, 0);

    // Show output on main canvas
    outputCanvas.width = imgWidth;
    outputCanvas.height = imgHeight;
    ctx.clearRect(0, 0, imgWidth, imgHeight);
    ctx.drawImage(imgCanvas, 0, 0);

    loading.textContent = '✅ Background removed!';
  });
</script>

</body>
</html>
